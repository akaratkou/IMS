services:
  resource-db:
    image: postgres:17-alpine
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=${RESOURCE_DB_NAME}
      - POSTGRES_PASSWORD=${RESOURCE_DB_PASSWORD}
      - POSTGRES_USER=${RESOURCE_DB_USERNAME}
    volumes:
      - ./init-scripts/resource-db:/docker-entrypoint-initdb.d:ro

  song-db:
    image: postgres:17-alpine
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_DB=${SONG_DB_NAME}
      - POSTGRES_PASSWORD=${SONG_DB_PASSWORD}
      - POSTGRES_USER=${SONG_DB_USERNAME}
    volumes:
      - ./init-scripts/song-db:/docker-entrypoint-initdb.d:ro


  resource-service:
    build:
      context: ./resource-service
      dockerfile: Dockerfile
    ports:
      - "${RESOURCE_SERVICE_EXPOSE_PORT}:8080"
    restart: on-failure
    environment:
      - SPRING_DATASOURCE_URL=${RESOURCE_DB_URL}
      - SPRING_DATASOURCE_USERNAME=${RESOURCE_DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${RESOURCE_DB_PASSWORD}
      - METADATA_SERVICE_URL=http://song-service:8080
      - APP_PORT=8080
    depends_on:
      - resource-db


  song-service:
    build:
      context: ./song-service
      dockerfile: Dockerfile
    ports:
      - "${SONG_SERVICE_EXPOSE_PORT}:8080"
    restart: on-failure
    environment:
      - SPRING_DATASOURCE_URL=${SONG_DB_URL}
      - SPRING_DATASOURCE_USERNAME=${SONG_DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SONG_DB_PASSWORD}
      - APP_PORT=8080
    depends_on:
      - song-db
      - resource-db

